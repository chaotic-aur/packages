# Maintainer: aur.chaotic.cx

## options
: ${_plugin_aja:=false}

_pkgname="obs-studio"
pkgname="$_pkgname-stable"
pkgver=32.0.2
pkgrel=1
pkgdesc="Free, open source software for live streaming and recording - Browser enabled"
url="https://github.com/obsproject/obs-studio"
license=("GPL-2.0-or-later")
arch=("x86_64")

depends=(
  'curl'
  'ffmpeg'
  'jack'
  'jansson'
  'libdatachannel'
  'libpipewire'
  'librist'
  'libvpl'
  'libxcomposite'
  'mbedtls'
  'pciutils'
  'qrcodegencpp-cmake'
  'qt6-svg'
  'rnnoise'
  'speexdsp'
)
makedepends=(
  'asio'
  'cmake'
  'extra-cmake-modules'
  'ffnvcodec-headers'
  'git'
  'libfdk-aac'
  'luajit'
  'ninja'
  'nlohmann-json'
  'python'
  'qt6-wayland'
  'simde'
  'sndio'
  'swig'
  'uthash'
  'vlc'
  'wayland'
  'websocketpp'
  'x264'
  'xdg-desktop-portal'
)
optdepends=(
  'libfdk-aac: FDK AAC codec support'
  'libva-intel-driver: hardware encoding'
  'libva-mesa-driver: hardware encoding'
  'luajit: scripting support'
  'python: scripting support'
  'sndio: sndio input client'
  'v4l2loopback-dkms: virtual camera support'
  'vlc: VLC Media Source'
)

if [ "${_plugin_aja::1}" == "t" ]; then
  depends+=('libajantv2') # AUR
  _plugin_aja='ON'
else
  _plugin_aja='OFF'
fi

provides=("$_pkgname=${pkgver%%.r*}")
conflicts=("$_pkgname")

options=('!lto' '!strip')

_source_main() {
  _pkgsrc="$_pkgname"
  source=("$_pkgsrc"::"git+$url.git#tag=$pkgver")
  sha256sums=('SKIP')
}

_source_cef() {
  depends+=(
    'at-spi2-core'
    'libxdamage'
    'libxrandr'
    'nspr'
    'nss'
  )

  local _response _cef_dl_url _cef_hash _cef_filename
  _response=$(curl -Ssf --follow --retry 3 "$url/raw/refs/tags/$pkgver/build-aux/modules/99-cef.json")

  _cef_dl_url=$(grep -Pom1 '"url": "\K[^"]+' <<< "$_response")
  _cef_hash=$(grep -Pom1 '"sha256": "\K[0-9a-f]+' <<< "$_response")
  _cef_filename=$(basename "$_cef_dl_url")
  _cef_src=$(sed -E 's&(_v[0-9]+)?\..*$&&' <<< "$_cef_filename")

  source+=("$_cef_filename"::"$_cef_dl_url")
  sha256sums+=("$_cef_hash")
}

_source_main
_source_cef

prepare() {
  cd "$_pkgsrc"
  git rm -r deps/libdshowcapture/src
  git submodule update --init --recursive --depth 1

  # fix for Qt 6.10
  sed -e 's&Qt::GuiPrivate&&' \
    -i frontend/cmake/os-freebsd.cmake frontend/cmake/os-linux.cmake

  sed -e '/GuiPrivate/d' \
    -i frontend/plugins/aja-output-ui/CMakeLists.txt \
    frontend/plugins/decklink-output-ui/CMakeLists.txt \
    frontend/plugins/frontend-tools/CMakeLists.txt
}

build() (
  export CFLAGS CXXFLAGS
  CFLAGS="${CFLAGS/_FORTIFY_SOURCE=?/_FORTIFY_SOURCE=2}"
  CXXFLAGS="${CXXFLAGS/_FORTIFY_SOURCE=?/_FORTIFY_SOURCE=2}"

  local _cmake_options=(
    -B build
    -S "$_pkgsrc"
    -G Ninja
    -DCMAKE_BUILD_TYPE=None
    -DCMAKE_INSTALL_PREFIX='/usr'
    -DCMAKE_INSTALL_LIBDIR='lib'
    -DCEF_ROOT_DIR="$srcdir/$_cef_src"
    -DOBS_VERSION_OVERRIDE="${pkgver%%.r*}"
    -DOBS_COMPILE_DEPRECATION_AS_WARNING=ON
    -DENABLE_BROWSER=ON # qrcodegencpp-cmake
    -DENABLE_LIBFDK=ON
    -Wno-dev

    -DENABLE_AJA="${_plugin_aja:?}"
    -DENABLE_JACK=ON
    -DENABLE_NEW_MPEGTS_OUTPUT=ON
    -DENABLE_VLC=OFF
    -DENABLE_VST=ON
    -DENABLE_WEBRTC=ON
  )

  cmake "${_cmake_options[@]}"
  cmake --build build
)

package() {
  DESTDIR="$pkgdir" cmake --install build
  chmod -R u+rwX,go+rX,go-w "$pkgdir"
}

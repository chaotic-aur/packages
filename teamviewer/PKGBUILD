pkgname=teamviewer
pkgver=15.70.6
pkgrel=1
pkgdesc='All-In-One Software for Remote Support and Online Meetings'
arch=('i686' 'x86_64' 'armv7h' 'aarch64')
url='https://www.teamviewer.com/en/download/portal/linux/'
license=('custom')
options=('!strip')
provides=('teamviewer')
conflicts=('teamviewer-beta')
# /opt/teamviewer/tv_bin/script/teamviewer_setup checklibs can check deps for each TV component:
# TV_DMN, TV_DESK, TV_GUI
depends=(
  'hicolor-icon-theme'
  'qt5-x11extras'
  'qt5-quickcontrols' # Doesn't appear in namcap, won't display UI without it.
  'qt5-webengine'
  'qt5-svg'
)
#depends_x86_64=(
# libdepends:
#	'lib32-libxtst'
#	'lib32-libxinerama'
#	'lib32-libxrandr'
#	'lib32-libxdamage'
#	'lib32-fontconfig'
#	'lib32-libsm')
#depends_i686=()
#depends_armv7h=()
install=teamviewer.install
source_x86_64=("https://dl.teamviewer.com/download/linux/version_${pkgver%%.*}x/teamviewer_${pkgver}_amd64.deb")
source_i686=("https://dl.teamviewer.com/download/linux/version_${pkgver%%.*}x/teamviewer_${pkgver}_i386.deb")
source_armv7h=("https://dl.teamviewer.com/download/linux/version_${pkgver%%.*}x/teamviewer_${pkgver}_armhf.deb")
source_aarch64=("https://dl.teamviewer.com/download/linux/version_${pkgver%%.*}x/teamviewer_${pkgver}_arm64.deb")
sha256sums_i686=('ff1b74221c61bf1d5b557457c1829a0992389df4f686f4ac05924d2a86bc833f')
sha256sums_x86_64=('dfd8493d1f6b4b910068d7348da06777060091213baf6773d07d6f4037d484af')
sha256sums_armv7h=('0e00499b8735acb7f05fcc87321fefe01e0f5724fa16fe7745b3633798f0b423')
sha256sums_aarch64=('99724e6c2f0a163464c3a21b48ea4bd4cc4be7c064e10a2f03ccc36a53e2e7a8')

prepare() {
  warning "If the install fails, you need to uninstall previous major version of Teamviewer"
  [ -d data ] && rm -rf data
  mkdir data
  cd data
  for datatar in ../data.tar.*; do
    msg2 "Unpacking $datatar"
    tar -xf $datatar
  done
  sed -i '/function CheckQtQuickControls()/{N;a ls /usr/lib/qt/qml/QtQuick/Controls/qmldir &>/dev/null && return # ArchLinux
}' ./opt/teamviewer/tv_bin/script/teamviewer_setup || msg2 "Patching CheckQtQuickControls failed! Contact maintainer"
  msg2 "Running teamviewer_setup checklibs"
  ./opt/teamviewer/tv_bin/script/teamviewer_setup checklibs \
    || msg2 "teamviewer_setup checklibs failed, contact maintainer with /tmp/teamviewerTARLibCheck/DependencyCheck.log" # Currently it always exits 0
}

package() {
  # Install
  warning "If the install fails, you need to uninstall previous major version of Teamviewer"
  cp -dr --no-preserve=ownership ./data/{etc,opt,usr,var} "${pkgdir}"/

  # Additional files
  #rm "${pkgdir}"/opt/teamviewer/tv_bin/xdg-utils/xdg-email
  rm -rf "${pkgdir}"/etc/apt
  install -D -m0644 "${pkgdir}"/opt/teamviewer/tv_bin/script/teamviewerd.service \
    "${pkgdir}"/usr/lib/systemd/system/teamviewerd.service
  install -d -m0755 "${pkgdir}"/usr/{share/applications,share/licenses/teamviewer}
  ln -s /opt/teamviewer/License.txt \
    "${pkgdir}"/usr/share/licenses/teamviewer/LICENSE
  if [ "$CARCH" = "x86_64" ] && [ -f "${pkgdir}/opt/teamviewer/tv_bin/script/libdepend" ]; then
    msg2 "Removing libdepend to ditch lib32 dependencies"
    rm "${pkgdir}/opt/teamviewer/tv_bin/script/libdepend"
  fi
  # Uncomment to use system's native libraries. This can save around 150MiB of disk space
  #rm -rf "${pkgdir}"/opt/teamviewer/tv_bin/RTlib
}

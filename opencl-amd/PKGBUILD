# Maintainer: George Sofianos <george at sofianos dot dev>

# Release notes https://rocm.docs.amd.com/en/latest/about/release-notes.html
_amdgpu_repo='https://repo.radeon.com/amdgpu/7.0/ubuntu'
_rocm_repo='https://repo.radeon.com/rocm/apt/7.0'
_opencl_lib='opt/rocm-7.0.0/opencl/lib'
_rocm_lib='opt/rocm-7.0.0/lib'
_hip_lib='opt/rocm-7.0.0/hip/lib/'
_amdgpu="opt/amdgpu/lib/x86_64-linux-gnu"
_amdgpu_pro="opt/amdgpu-pro/lib/x86_64-linux-gnu/"

pkgname=opencl-amd
pkgdesc="ROCm components repackaged from AMD's Ubuntu releases (ROCr runtime, ROCm runtime, HIP runtime) - This package is intended to work along with the free amdgpu stack."
pkgver=7.0.0
pkgrel=2
epoch=1
arch=('x86_64')
url='http://www.amd.com'
license=('custom:AMD')
makedepends=('wget')
depends=('libdrm' 'ocl-icd' 'gcc-libs' 'numactl')
provides=('opencl-driver' 'rocm' 'rocm-core' 'comgr' 'rocm-hip' 'hip' 'hipcc' 'hip-dev' 'hip-doc' 'hip-samples' 'hsa-rocr' 'hsa-rocr-dev' 'rocminfo' 'hip-runtime-amd' 'rocm-device-libs' 'rocm-language-runtime'
  'rocm-hip-runtime' 'rocdecode' 'rocdecode-dev' 'rocjpeg' 'rocjpeg-dev' 'rocm-ocl-icd' 'rocm-opencl-icd-loader' 'rocm-opencl' 'rocm-opencl-dev' 'rocm-opencl-runtime' 'rocm-dbgapi' 'rocm-debug-agent' 'rocm-gdb'
  'rocprofiler' 'rocprofiler-dev' 'rocprofiler-plugins' 'rocprofiler-register' 'rocprofiler-sdk-rocpd' 'roctracer' 'roctracer-dev' 'hsa-amd-aqlprofile' 'rocm-openmp' 'openmp-extras-runtime' 'rocm-cmake' 'rocm-utils' 'rocm-smi-lib' 'amd-smi-lib')
conflicts=('rocm-opencl-runtime' 'rocm' 'rocm-core' 'comgr' 'rocm-hip' 'hip' 'hipcc' 'hip-dev' 'hip-doc' 'hip-samples' 'hsa-rocr' 'hsa-rocr-dev' 'rocminfo' 'hip-runtime-amd' 'rocm-device-libs' 'rocm-language-runtime'
  'rocm-hip-runtime' 'rocdecode' 'rocdecode-dev' 'rocjpeg' 'rocjpeg-dev' 'rocm-ocl-icd' 'rocm-opencl-icd-loader' 'rocm-opencl' 'rocm-opencl-dev' 'rocm-opencl-runtime' 'rocm-dbgapi' 'rocm-debug-agent' 'rocm-gdb'
  'rocprofiler' 'rocprofiler-dev' 'rocprofiler-plugins' 'rocprofiler-register' 'rocprofiler-sdk-rocpd' 'roctracer' 'roctracer-dev' 'hsa-amd-aqlprofile' 'rocm-openmp' 'openmp-extras-runtime' 'rocm-cmake' 'rocm-utils' 'rocm-smi-lib' 'amd-smi-lib')
optdepends=('clinfo' 'opencl-amd-dev')

source=(
  # ROCM
  "https://repo.radeon.com/rocm/apt/7.0/pool/main/r/rocm-core/rocm-core_7.0.0.70000-38~24.04_amd64.deb"
  "https://repo.radeon.com/rocm/apt/7.0/pool/main/c/comgr/comgr_3.0.0.70000-38~24.04_amd64.deb"
  "https://repo.radeon.com/rocm/apt/7.0/pool/main/h/hipcc/hipcc_1.1.1.70000-38~24.04_amd64.deb"
  "https://repo.radeon.com/rocm/apt/7.0/pool/main/h/hip-dev/hip-dev_7.0.51831.70000-38~24.04_amd64.deb"
  "https://repo.radeon.com/rocm/apt/7.0/pool/main/h/hip-doc/hip-doc_7.0.51831.70000-38~24.04_amd64.deb"
  "https://repo.radeon.com/rocm/apt/7.0/pool/main/h/hip-samples/hip-samples_7.0.51831.70000-38~24.04_amd64.deb"
  "https://repo.radeon.com/rocm/apt/7.0/pool/main/h/hsa-rocr/hsa-rocr_1.18.0.70000-38~24.04_amd64.deb"
  "https://repo.radeon.com/rocm/apt/7.0/pool/main/h/hsa-rocr-dev/hsa-rocr-dev_1.18.0.70000-38~24.04_amd64.deb"
  "https://repo.radeon.com/rocm/apt/7.0/pool/main/r/rocminfo/rocminfo_1.0.0.70000-38~24.04_amd64.deb"
  "https://repo.radeon.com/rocm/apt/7.0/pool/main/h/hip-runtime-amd/hip-runtime-amd_7.0.51831.70000-38~24.04_amd64.deb"
  "https://repo.radeon.com/rocm/apt/7.0/pool/main/r/rocm-device-libs/rocm-device-libs_1.0.0.70000-38~24.04_amd64.deb"
  "https://repo.radeon.com/rocm/apt/7.0/pool/main/r/rocm-language-runtime/rocm-language-runtime_7.0.0.70000-38~24.04_amd64.deb"
  "https://repo.radeon.com/rocm/apt/7.0/pool/main/r/rocm-hip-runtime/rocm-hip-runtime_7.0.0.70000-38~24.04_amd64.deb"
  "https://repo.radeon.com/rocm/apt/7.0/pool/main/r/rocdecode/rocdecode_1.0.0.70000-38~24.04_amd64.deb"
  "https://repo.radeon.com/rocm/apt/7.0/pool/main/r/rocdecode-dev/rocdecode-dev_1.0.0.70000-38~24.04_amd64.deb"
  "https://repo.radeon.com/rocm/apt/7.0/pool/main/r/rocjpeg/rocjpeg_1.1.0.70000-38~24.04_amd64.deb"
  "https://repo.radeon.com/rocm/apt/7.0/pool/main/r/rocjpeg-dev/rocjpeg-dev_1.1.0.70000-38~24.04_amd64.deb"
  "https://repo.radeon.com/rocm/apt/7.0/pool/main/r/rocm-opencl/rocm-opencl_2.0.0.70000-38~24.04_amd64.deb"
  "https://repo.radeon.com/rocm/apt/7.0/pool/main/r/rocm-opencl-dev/rocm-opencl-dev_2.0.0.70000-38~24.04_amd64.deb"
  "https://repo.radeon.com/rocm/apt/7.0/pool/main/r/rocm-opencl-runtime/rocm-opencl-runtime_7.0.0.70000-38~24.04_amd64.deb"
  # ROCM DEV
  "https://repo.radeon.com/rocm/apt/7.0/pool/main/o/openmp-extras-runtime/openmp-extras-runtime_20.70.0.70000-38~24.04_amd64.deb"
  "https://repo.radeon.com/rocm/apt/7.0/pool/main/r/rocm-smi-lib/rocm-smi-lib_7.8.0.70000-38~24.04_amd64.deb"
  "https://repo.radeon.com/rocm/apt/7.0/pool/main/a/amd-smi-lib/amd-smi-lib_26.0.0.70000-38~24.04_amd64.deb"
  "https://repo.radeon.com/rocm/apt/7.0/pool/main/r/rocm-cmake/rocm-cmake_0.14.0.70000-38~24.04_amd64.deb"
  "https://repo.radeon.com/rocm/apt/7.0/pool/main/r/rocm-dbgapi/rocm-dbgapi_0.77.3.70000-38~24.04_amd64.deb"
  "https://repo.radeon.com/rocm/apt/7.0/pool/main/r/rocm-debug-agent/rocm-debug-agent_2.1.0.70000-38~24.04_amd64.deb"
  "https://repo.radeon.com/rocm/apt/7.0/pool/main/r/rocm-gdb/rocm-gdb_16.3.70000-38~24.04_amd64.deb"
  "https://repo.radeon.com/rocm/apt/7.0/pool/main/r/rocm-utils/rocm-utils_7.0.0.70000-38~24.04_amd64.deb"
  "https://repo.radeon.com/rocm/apt/7.0/pool/main/r/rocprofiler/rocprofiler_2.0.70000.70000-38~24.04_amd64.deb"
  "https://repo.radeon.com/rocm/apt/7.0/pool/main/r/rocprofiler-dev/rocprofiler-dev_2.0.70000.70000-38~24.04_amd64.deb"
  "https://repo.radeon.com/rocm/apt/7.0/pool/main/r/rocprofiler-plugins/rocprofiler-plugins_2.0.70000.70000-38~24.04_amd64.deb"
  "https://repo.radeon.com/rocm/apt/7.0/pool/main/r/rocprofiler-register/rocprofiler-register_0.5.0.70000-38~24.04_amd64.deb"
  "https://repo.radeon.com/rocm/apt/7.0/pool/main/r/roctracer/roctracer_4.1.70000.70000-38~24.04_amd64.deb"
  "https://repo.radeon.com/rocm/apt/7.0/pool/main/r/roctracer-dev/roctracer-dev_4.1.70000.70000-38~24.04_amd64.deb"
  "https://repo.radeon.com/rocm/apt/7.0/pool/main/r/rocm-dev/rocm-dev_7.0.0.70000-38~24.04_amd64.deb"
  "https://repo.radeon.com/rocm/apt/7.0/pool/main/h/hsa-amd-aqlprofile/hsa-amd-aqlprofile_1.0.0.70000-38~24.04_amd64.deb"
)

sha256sums=(
  #ROCM
  "948fc61105d7099438c3907203477aa04aea8fc1a8da89101b7eed2c6201afc4"
  "0d1596f95e4dd7610f052e7cd336397e50d35353a466240e946cfcfd15e22b58"
  "74d0522d7d247a5e2d50f74f333a44c943a72c9cf61159cbacf4146a0fd8df5a"
  "6b4695f295c94efd1e19d0507d4a1523e4589dfda903977bca6a058dd3f21288"
  "ecc72fafae865a9c7477ffd9acb1e3f78ee55082510d8e09def35b9f26da419b"
  "b6ff90f0190a079eb29e56f1787e8ac0fb6cfc1e8dd7f356e31149e65f6427b2"
  "fae1f8800a0598c4b6a0a91dc2965481f293d1431eace7c2600289acd1782919"
  "4bcd58ca5316df7e371723d5cc073e937d3af598c541130832dab3f90280c181"
  "d1ff61e9a677144c44c019787a22e62cc36427028c18bffaf6fec3ccae2f80f7"
  "ee37f8cdce7501945e9c81a0eb18123386b9404994d5a8068afdb64f335c83f6"
  "723f3d69ce57e7f865d2643d5cec9df88abe30b24d0412393b8b084b3752e126"
  "f9a7929bf917a4e751112a2cb714f21bcd006dec51e24244159b1a2f1082f87a"
  "fcc62380e4400965461ddaafccc61eb206e5453dc21ea3968a63f5a2bebe42b9"
  "579625a88cbcaa325d804f42a559363d44de9213259f40bd4e5834f1dc714e12"
  "9818ae75ca935634dd23318b5762ec750ce5bf5c4862875e7c88e24e3ac27b44"
  "8d030d859b70f6c675cd65df0303b8fc8e89a9f4f408f85136390c9121ad924f"
  "9bff85626e892c26fc8c9c58f9917f99efaae1a687d4fa72e9daf36c715b245b"
  "c567f0bf6e53468f97c332f4d0f09052404fe7bc4609651a3634853d53eaf4c4"
  "1bba435157f2991d2ed95db0eb22c17296e2c24d98d2946c0b7689e8e2126814"
  "f880ca9ada42f53162d014d041644f24e8241f305feb53729c2ac858ac94981b"
  # ROCM DEV
  "ed86c76818ff296b2aed0fe6203fc16377602f19cd371e0bd676f6d751a53e07"
  "d7672980213746407955bf90c4fcc3f8de7f0aad17b5373d22329826f49738e0"
  "9a1f0b91e20138d5bb1711d03630eb9376651e156ada11d4950304226b4ccda2"
  "99c0a7fd446ff855ea3fdeccd18dce97a8cfb28b848cdeb1a60bee554e39d1bf"
  "7734a271c5220c62d9ab542dce66f386ad24c3ec330622ab4cfb38bff919f3b8"
  "0d352a2cbf0de2db48a50428f26066505721e0b662fab5b3d7f794a2a4399cb7"
  "589dc3d8ce3c153cb89840fc504081836deed53fbaaef6889c24be5e21074744"
  "98c33b3a65c61256ba59e4a2aed8ef98483a6ae3775887eb49dd1340edc88706"
  "2944ee1dfe947db584d9c0523c77d91fcd0c32f05273c324f90fcbfc5021b0bb"
  "6d4e68c7146e55bcd238c10709791899875c67208038fc4e866f8693d4581cc6"
  "2c7efff2896c75478deafda956778dd001a82a90bcdf8b748b8ef4d086c77630"
  "ae73c37fdd523066df7ce4626d782b54ac1d123a9c3d612aed1322b7e05dea36"
  "5f12ec2de6b051eeefd7ce77314400b9d8bc3abc9ea281935aad58b33e4bc1ac"
  "54c74aa3e051b0c4fed1c6c06b0abe05171cebfa06df017a444e18c7cdb1d75c"
  "075a0b614b4eb2648f4eda1f6e3b837c7aa97c25b6812d0c54f543c18ce414be"
  "603edcdd05df4b1d6244426f7fd654b790b68a333c584415e29b41407e142c2e"
)

package() {
  for p in *.deb; do
    ar x "${p}"
    if [[ -f data.tar.gz ]]; then
      # echo gz: "${srcdir}/${p}"
      tar xfx data.tar.gz
      rm data.tar.gz
    elif [[ -f data.tar.xz ]]; then
      # echo xz: "${srcdir}/${p}"
      tar xJf data.tar.xz
      rm data.tar.xz
    fi
  done

  mv "${srcdir}/opt/" "${pkgdir}/"
  mv "${pkgdir}/opt/rocm-7.0.0" "${pkgdir}/opt/rocm"

  mkdir -p "${pkgdir}/opt/amdgpu/share/libdrm"
  cd "${pkgdir}/opt/amdgpu/share/libdrm"
  ln -s /usr/share/libdrm/amdgpu.ids amdgpu.ids

  mkdir -p "${pkgdir}/etc/OpenCL/vendors"
  echo libamdocl64.so > "${pkgdir}/etc/OpenCL/vendors/amdocl64.icd"

  mkdir -p "${pkgdir}/etc/ld.so.conf.d"
  echo /opt/rocm/lib >> "$pkgdir/etc/ld.so.conf.d/opencl-amd.conf"
  echo /opt/rocm/hip/lib >> "$pkgdir/etc/ld.so.conf.d/opencl-amd.conf"

  mkdir -p "${pkgdir}/etc/profile.d"
  echo export PATH="\${PATH}:/opt/rocm/bin:/opt/rocm/hip/bin" > "$pkgdir/etc/profile.d/opencl-amd.sh"
}
